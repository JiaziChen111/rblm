<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLM example using simulated data • rblm</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">rblm</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example.html">BLM example using simulated data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>BLM example using simulated data</h1>
            
            <h4 class="date">13 November, 2017</h4>
          </div>

    
    
<div class="contents">
<p>Simulating and estimating teh interacted model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(rblm)
<span class="kw">require</span>(knitr)
<span class="kw">require</span>(kableExtra)
<span class="kw">options</span>(<span class="dt">knitr.table.format =</span> <span class="st">"html"</span>) </code></pre></div>
<div id="simulating-a-data-set" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-a-data-set" class="anchor"></a>Simulating a data set</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">43243123</span>)
model =<span class="st"> </span><span class="kw"><a href="../reference/m2.mini.new.html">m2.mini.new</a></span>(<span class="dv">10</span>,<span class="dt">serial =</span> F,<span class="dt">fixb=</span>T)
model<span class="op">$</span>Ns   =<span class="st"> </span><span class="kw">array</span>(<span class="dv">300000</span><span class="op">/</span>model<span class="op">$</span>nf,model<span class="op">$</span>nf)
model<span class="op">$</span>Nm   =<span class="st"> </span><span class="dv">10</span><span class="op">*</span><span class="kw">toeplitz</span>(<span class="kw">ceiling</span>(<span class="kw">seq</span>(<span class="dv">100</span>,<span class="dv">10</span>,<span class="dt">l=</span>model<span class="op">$</span>nf)))
sdata =<span class="st"> </span><span class="kw"><a href="../reference/m2.mini.simulate.stayers.html">m2.mini.simulate.stayers</a></span>(model,model<span class="op">$</span>Ns)
jdata =<span class="st"> </span><span class="kw"><a href="../reference/m2.mini.simulate.movers.html">m2.mini.simulate.movers</a></span>(model,model<span class="op">$</span>Nm)

<span class="co"># compute decomposition</span>
stayer_share =<span class="st"> </span><span class="kw">sum</span>(model<span class="op">$</span>Ns)<span class="op">/</span>(<span class="kw">sum</span>(model<span class="op">$</span>Ns)<span class="op">+</span><span class="kw">sum</span>(model<span class="op">$</span>Nm))
model<span class="op">$</span>vdec   =<span class="st"> </span><span class="kw"><a href="../reference/m2.mini.vdec.html">m2.mini.vdec</a></span>(model,<span class="fl">1e6</span>,stayer_share,<span class="st">"y1"</span>)</code></pre></div>
<pre><code>## INFO [2017-11-13 14:36:58] computing var decomposition with ns=817440 nm=182550
##   cor_kl cov_kl  var_k var_l    rsq
## 1 0.1837  0.154 0.4821 0.364 0.9207</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># randomly assign firm IDs</span>
sdata &lt;-<span class="st"> </span>sdata[,f1<span class="op">:</span><span class="er">=</span><span class="kw">paste</span>(<span class="st">"F"</span>,j1 <span class="op">+</span><span class="st"> </span>model<span class="op">$</span>nf<span class="op">*</span>(<span class="kw">sample.int</span>(.N<span class="op">/</span><span class="dv">50</span>,.N,<span class="dt">replace=</span>T)<span class="op">-</span><span class="dv">1</span>),<span class="dt">sep=</span><span class="st">""</span>),j1]
sdata &lt;-<span class="st"> </span>sdata[,j1b<span class="op">:</span><span class="er">=</span>j1]
sdata &lt;-<span class="st"> </span>sdata[,j1true <span class="op">:</span><span class="er">=</span><span class="st"> </span>j1]
jdata &lt;-<span class="st"> </span>jdata[,j1true <span class="op">:</span><span class="er">=</span><span class="st"> </span>j1][,j2true <span class="op">:</span><span class="er">=</span><span class="st"> </span>j2]
jdata &lt;-<span class="st"> </span>jdata[,j1c<span class="op">:</span><span class="er">=</span>j1]
jdata &lt;-<span class="st"> </span>jdata[,f1<span class="op">:</span><span class="er">=</span><span class="kw">sample</span>( <span class="kw">unique</span>(sdata[j1b<span class="op">==</span>j1c,f1]) ,.N,<span class="dt">replace=</span>T),j1c]
jdata &lt;-<span class="st"> </span>jdata[,j2c<span class="op">:</span><span class="er">=</span>j2]
jdata &lt;-<span class="st"> </span>jdata[,f2<span class="op">:</span><span class="er">=</span><span class="kw">sample</span>( <span class="kw">unique</span>(sdata[j1b<span class="op">==</span>j2c,f1])  ,.N,<span class="dt">replace=</span>T),j2c]
jdata<span class="op">$</span>j2c=<span class="ot">NULL</span>
jdata<span class="op">$</span>j1c=<span class="ot">NULL</span>
sdata<span class="op">$</span>j1b=<span class="ot">NULL</span>

<span class="co"># combine the movers and stayers, ad stands for all data:</span>
ad =<span class="st"> </span><span class="kw">list</span>(<span class="dt">sdata=</span>sdata,<span class="dt">jdata=</span>jdata)

<span class="co"># plot firm size distribution</span>
<span class="kw">ggplot</span>(ad<span class="op">$</span>sdata[,.N,f1],<span class="kw">aes</span>(<span class="dt">x=</span>N)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth=</span><span class="dv">1</span>)</code></pre></div>
<p><img src="example_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
</div>
<div id="clustering-firms" class="section level1">
<h1 class="hasAnchor">
<a href="#clustering-firms" class="anchor"></a>Clustering firms</h1>
<p>We start by extracting the measures that will be used to cluster</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ms    =<span class="st"> </span><span class="kw"><a href="../reference/grouping.getMeasures.html">grouping.getMeasures</a></span>(ad,<span class="st">"ecdf"</span>,<span class="dt">Nw=</span><span class="dv">20</span>,<span class="dt">y_var =</span> <span class="st">"y1"</span>)</code></pre></div>
<pre><code>## INFO [2017-11-13 14:37:06] processing 6000 firms
## INFO [2017-11-13 14:37:06] computing measures...
## INFO [2017-11-13 14:37:06] computing weights...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># then we group we choose k=10</span>
grps  =<span class="st"> </span><span class="kw"><a href="../reference/grouping.classify.once.html">grouping.classify.once</a></span>(ms,<span class="dt">k =</span> <span class="dv">10</span>,<span class="dt">nstart =</span> <span class="dv">1000</span>,<span class="dt">iter.max =</span> <span class="dv">200</span>,<span class="dt">step=</span><span class="dv">250</span>)</code></pre></div>
<pre><code>## INFO [2017-11-13 14:37:06] clustering T=50.999467, Nw=20 , measure=ecdf
## INFO [2017-11-13 14:37:06] running weigthed kmeans step=250 total=1000
## INFO [2017-11-13 14:37:06] nobs=6000 nmeasures=20
## INFO [2017-11-13 14:37:08] [25%] tot=445.183986 best=445.183986 &lt;&lt;&lt;&lt;
## INFO [2017-11-13 14:37:10] [50%] tot=445.183986 best=445.183986
## INFO [2017-11-13 14:37:12] [75%] tot=445.183986 best=445.183986
## INFO [2017-11-13 14:37:14] [100%] tot=445.183986 best=445.183986
## INFO [2017-11-13 14:37:14] k=10 WSS=445.183986 nstart=1000 nfrims=6000</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># finally we append the results to adata</span>
ad   =<span class="st"> </span><span class="kw"><a href="../reference/grouping.append.html">grouping.append</a></span>(ad,grps<span class="op">$</span>best_cluster,<span class="dt">drop=</span>T)

<span class="co"># we can also check the classification</span>
<span class="kw">ggplot</span>(ad<span class="op">$</span>sdata[,.N,<span class="kw">list</span>(j1,j1true)],<span class="kw">aes</span>(<span class="dt">x=</span>j1true,<span class="dt">y=</span>j1,<span class="dt">size=</span>N)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="example_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>In the previous command we tell rblm that we want to use the firm specific empirical measure “ecdf” with 20 points of supports and that the dependent variable is “y1”. The firm identifier should be “f1”.</p>
</div>
<div id="estimating-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#estimating-the-model" class="anchor"></a>Estimating the model</h1>
<p>This is a relatively old code, we will be pushing an update extremely soon!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res =<span class="st"> </span><span class="kw"><a href="../reference/m2.mini.estimate.html">m2.mini.estimate</a></span>(ad<span class="op">$</span>jdata,ad<span class="op">$</span>sdata,<span class="dt">model0 =</span> model,<span class="dt">method =</span> <span class="st">"fixb"</span>)</code></pre></div>
<pre><code>## INFO [2017-11-13 14:37:15] computing var decomposition with ns=817440 nm=182559
##   cor_kl cov_kl  var_k  var_l    rsq
## 1 0.1805 0.1516 0.4852 0.3632 0.9196</code></pre>
<p><img src="example_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<pre><code>## cor with true model:0.987043</code></pre>
<p>We can show the decompositions next to each other:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(<span class="kw">rbind</span>(model<span class="op">$</span>vdec<span class="op">$</span>stats,res<span class="op">$</span>vdec<span class="op">$</span>stats),<span class="dt">digits =</span> <span class="dv">4</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/kableExtra/topics/kable_styling">kable_styling</a></span>(<span class="dt">bootstrap_options =</span> <span class="kw">c</span>(<span class="st">"striped"</span>, <span class="st">"bordered"</span>,<span class="st">"condensed"</span>), <span class="dt">full_width =</span> F)</code></pre></div>
<?xml version="1.0" encoding="UTF-8"?><table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;">
cor_kl
</th>
<th style="text-align:left;">
cov_kl
</th>
<th style="text-align:left;">
var_k
</th>
<th style="text-align:left;">
var_l
</th>
<th style="text-align:left;">
rsq
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
0.1837
</td>
<td style="text-align:left;">
0.154
</td>
<td style="text-align:left;">
0.4821
</td>
<td style="text-align:left;">
0.364
</td>
<td style="text-align:left;">
0.9207
</td>
</tr>
<tr>
<td style="text-align:left;">
0.1805
</td>
<td style="text-align:left;">
0.1516
</td>
<td style="text-align:left;">
0.4852
</td>
<td style="text-align:left;">
0.3632
</td>
<td style="text-align:left;">
0.9196
</td>
</tr>
</tbody>
</table>
<p>And we can plot the resulting wage</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/m2.mini.plotw.html">m2.mini.plotw</a></span>(res)</code></pre></div>
<p><img src="example_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
<div id="extract-all-necesserary-moments-for-off-line-estimation" class="section level1">
<h1 class="hasAnchor">
<a href="#extract-all-necesserary-moments-for-off-line-estimation" class="anchor"></a>Extract all necesserary moments for off-line estimation</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mstats =<span class="st"> </span>ad<span class="op">$</span>jdata[,<span class="kw">list</span>(<span class="dt">m1=</span><span class="kw">mean</span>(y1),<span class="dt">sd1=</span><span class="kw">sd</span>(y1),
                         <span class="dt">m2=</span><span class="kw">mean</span>(y2),<span class="dt">sd2=</span><span class="kw">sd</span>(y2),
                         <span class="dt">v12 =</span> <span class="kw">cov</span>(y1,y2),.N),<span class="kw">list</span>(j1,j2)]
cstats =<span class="st"> </span>ad<span class="op">$</span>sdata[,<span class="kw">list</span>(<span class="dt">m1=</span><span class="kw">mean</span>(y1),<span class="dt">sd1=</span><span class="kw">sd</span>(y1),
                         <span class="dt">m2=</span><span class="kw">mean</span>(y2),<span class="dt">sd2=</span><span class="kw">sd</span>(y2),
                         <span class="dt">v12 =</span> <span class="kw">cov</span>(y1,y2),.N),<span class="kw">list</span>(j1)]</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#simulating-a-data-set">Simulating a data set</a></li>
      <li><a href="#clustering-firms">Clustering firms</a></li>
      <li><a href="#estimating-the-model">Estimating the model</a></li>
      <li><a href="#extract-all-necesserary-moments-for-off-line-estimation">Extract all necesserary moments for off-line estimation</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Stephane Bonhomme, Thibaut Lamadon, Elena Manresa.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
