<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mixture model example • rblm</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Mixture model example">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rblm</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example.html">Interacted model example</a>
    </li>
    <li>
      <a href="../articles/example_mixt.html">Mixture model example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tlamadon/rblm">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Mixture model example</h1>
            
            <h4 class="date">14 May, 2018</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tlamadon/rblm/blob/master/vignettes/example_mixt.Rmd"><code>vignettes/example_mixt.Rmd</code></a></small>
      <div class="hidden name"><code>example_mixt.Rmd</code></div>

    </div>

    
    
<p>Simulating and estimating the mixture model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(rblm)
<span class="kw">require</span>(knitr)
<span class="kw">require</span>(kableExtra)
<span class="kw">options</span>(<span class="dt">knitr.table.format =</span> <span class="st">"html"</span>) </code></pre></div>
<div id="simulating-a-data-set" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-a-data-set" class="anchor"></a>Simulating a data set</h1>
<p>The interacted model has the following equations:</p>
<p><span class="math display">\[  Pr[ Y_{it} \leq y | k,\ell ] = \Phi( \mu_{k\ell}, \sigma_{k\ell}) \]</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">324313</span>)
model =<span class="st"> </span><span class="kw"><a href="../reference/m2.mixt.new.html">m2.mixt.new</a></span>(<span class="dt">nk=</span><span class="dv">3</span>,<span class="dt">nf=</span><span class="dv">5</span>,<span class="dt">fixb=</span>T,<span class="dt">stationary =</span> T)

<span class="co"># simple complementatiry</span>
model<span class="op">$</span>A1 =<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dt">l=</span>model<span class="op">$</span>nf) <span class="op">%o%</span><span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dt">l=</span>model<span class="op">$</span>nk)
model<span class="op">$</span>A2 =<span class="st"> </span>model<span class="op">$</span>A1

<span class="co"># small variance</span>
model<span class="op">$</span>S1[] =<span class="st"> </span><span class="fl">0.2</span>
model<span class="op">$</span>S2[] =<span class="st"> </span><span class="fl">0.2</span>

<span class="co"># simple sorting</span>
model<span class="op">$</span>pk0[<span class="dv">1</span>,,] =<span class="st"> </span><span class="kw">exp</span>(<span class="dv">3</span><span class="op">*</span>model<span class="op">$</span>A1)<span class="op">/</span><span class="kw">rowSums</span>(<span class="kw">exp</span>(<span class="dv">3</span><span class="op">*</span>model<span class="op">$</span>A1))

<span class="co"># setting the number of movers and stayers </span>
model<span class="op">$</span>NNs   =<span class="st"> </span><span class="kw">array</span>(<span class="dv">300000</span><span class="op">/</span>model<span class="op">$</span>nf,model<span class="op">$</span>nf)
model<span class="op">$</span>NNm   =<span class="st"> </span>model<span class="op">$</span>nf<span class="op">*</span><span class="kw">toeplitz</span>(<span class="kw">ceiling</span>(<span class="kw">seq</span>(<span class="dv">100</span>,<span class="dv">10</span>,<span class="dt">l=</span>model<span class="op">$</span>nf)))

<span class="co"># creating a simulated data set</span>
ad =<span class="st">  </span><span class="kw"><a href="../reference/m2.mixt.simulate.sim.html">m2.mixt.simulate.sim</a></span>(model,<span class="dt">fsize =</span> <span class="dv">40</span>)

<span class="co"># plot firm size distribution</span>
<span class="kw">ggplot</span>(ad<span class="op">$</span>sdata[,.N,f1],<span class="kw">aes</span>(<span class="dt">x=</span>N)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth=</span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="example_mixt_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div id="clustering-firms" class="section level1">
<h1 class="hasAnchor">
<a href="#clustering-firms" class="anchor"></a>Clustering firms</h1>
<p>We start by extracting the measures that will be used to cluster</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># constructing the measures, we use empirical CDF at each firm</span>
ms    =<span class="st"> </span><span class="kw"><a href="../reference/grouping.getMeasures.html">grouping.getMeasures</a></span>(ad,            <span class="co"># the data</span>
                             <span class="st">"ecdf"</span>,        <span class="co"># the type of moments to construct at the firm level</span>
                             <span class="dt">Nw=</span><span class="dv">10</span>,         <span class="co"># number of point of support to use for the method</span>
                             <span class="dt">y_var =</span> <span class="st">"y1"</span>)  <span class="co"># variable to use to construct moments</span></code></pre></div>
<pre><code>## INFO [2018-05-14 18:38:50] processing 7500 firms
## INFO [2018-05-14 18:38:50] computing measures...
## INFO [2018-05-14 18:38:50] computing weights...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># classify into groups</span>
grps  =<span class="st"> </span><span class="kw"><a href="../reference/grouping.classify.once.html">grouping.classify.once</a></span>(ms,                  <span class="co"># input the measures to use</span>
                               <span class="dt">k =</span> <span class="dv">5</span>,               <span class="co"># number of groups</span>
                               <span class="dt">nstart =</span> <span class="dv">1000</span>,       <span class="co"># number of starting values for kmean</span>
                               <span class="dt">iter.max =</span> <span class="dv">200</span>,      <span class="co"># max number of iterations for each kmean</span>
                               <span class="dt">step=</span><span class="dv">250</span>)            <span class="co"># how often to show output</span></code></pre></div>
<pre><code>## INFO [2018-05-14 18:38:50] clustering T=41.004107, Nw=10 , measure=ecdf
## INFO [2018-05-14 18:38:50] running weigthed kmeans step=250 total=1000
## INFO [2018-05-14 18:38:50] nobs=7500 nmeasures=10
## INFO [2018-05-14 18:38:52] [25%] tot=844.071415 best=844.071415 &lt;&lt;&lt;&lt;
## INFO [2018-05-14 18:38:53] [50%] tot=844.071415 best=844.071415
## INFO [2018-05-14 18:38:54] [75%] tot=844.071415 best=844.071415
## INFO [2018-05-14 18:38:55] [100%] tot=844.071415 best=844.071415
## INFO [2018-05-14 18:38:55] k=5 WSS=844.071415 nstart=1000 nfrims=7500</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># finally we append the results to adata</span>
ad   =<span class="st"> </span><span class="kw"><a href="../reference/grouping.append.html">grouping.append</a></span>(ad,grps<span class="op">$</span>best_cluster,<span class="dt">drop=</span>T)

<span class="co"># we can also check the classification</span>
<span class="kw">ggplot</span>(ad<span class="op">$</span>sdata[,.N,<span class="kw">list</span>(j1,j1true)],<span class="kw">aes</span>(<span class="dt">x=</span>j1true,<span class="dt">y=</span>j1,<span class="dt">size=</span>N)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">"true type"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="st">"estimated group"</span>)</code></pre></div>
<p><img src="example_mixt_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>In the previous command we tell rblm that we want to use the firm specific empirical measure “ecdf” with 20 points of supports and that the dependent variable is “y1”. The firm identifier should be “f1”.</p>
</div>
<div id="estimating-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#estimating-the-model" class="anchor"></a>Estimating the model</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># we set control parameters for the EM</span>
ctrl  =<span class="st"> </span><span class="kw"><a href="../reference/em.control.html">em.control</a></span>( <span class="dt">nplot=</span><span class="dv">10000</span>,         <span class="co"># how often to plot (either wages, or model versus model0)</span>
                    <span class="dt">ncat =</span><span class="dv">2000</span>,          <span class="co"># how often to show step increases (large to keep output small)</span>
                    <span class="dt">model0 =</span> model,      <span class="co"># a model to compare estimates too (this is for testing)  </span>
                    <span class="dt">fixb=</span><span class="ot">TRUE</span>,           <span class="co"># impose fixed interactions over time</span>
                    <span class="dt">tol=</span><span class="fl">1e-7</span>,            <span class="co"># tolerance to stop EM      </span>
                    <span class="dt">est_rep=</span><span class="dv">2</span>,           <span class="co"># number of starting values to use (we usually use 50)</span>
                    <span class="dt">est_nbest=</span><span class="dv">1</span>,         <span class="co"># how many best liklihood to choose the best connected model from (we usually use 10)</span>
                    <span class="dt">sdata_subsample=</span><span class="fl">0.1</span>) <span class="co"># whether to sub-sample the stayers in estimation</span>

res =<span class="st"> </span><span class="kw"><a href="../reference/m2.mixt.estimate.all.html">m2.mixt.estimate.all</a></span>(<span class="dt">sim=</span>ad,         <span class="co"># the data</span>
                           <span class="dt">nk=</span>model<span class="op">$</span>nk,    <span class="co"># number of worker types (we use here the same as in simulation)</span>
                           <span class="dt">ctrl=</span>ctrl)      <span class="co"># parameters to control the EM</span></code></pre></div>
<pre><code>## INFO [2018-05-14 18:39:08] [233][para0][final] lik=-1645.3951 dlik=9.7191e-08 liks=-1.6431e+03 likm=0.0000e+00
## INFO [2018-05-14 18:39:08] starting repetitions with 1 nodes
## INFO [2018-05-14 18:39:09] [ 31][paraf (1/2)][final] lik=-33198.5347 dlik=8.9609e-08 liks=-3.3194e+04 likm=0.0000e+00
## INFO [2018-05-14 18:39:26] [358][para1 (1/2)][final] lik=-1644.9184 dlik=9.2612e-08 liks=-1.6426e+03 likm=0.0000e+00
## INFO [2018-05-14 18:40:56] [2000][move1 (1/2)] lik=-208.8048 dlik=2.1403e-07 liks=-2.0761e+02 likm=0.0000e+00
## INFO [2018-05-14 18:40:56] [2000][move1 (1/2)][final] lik=-208.8048 dlik=2.1403e-07 liks=-2.0761e+02 likm=0.0000e+00
## INFO [2018-05-14 18:40:56] done with reptitions 1/2
## INFO [2018-05-14 18:40:57] [ 13][paraf (2/2)][final] lik=-80230.6618 dlik=9.7492e-08 liks=-8.0227e+04 likm=0.0000e+00
## INFO [2018-05-14 18:41:05] [186][para1 (2/2)][final] lik=-1799.6715 dlik=9.6416e-08 liks=-1.7975e+03 likm=0.0000e+00
## INFO [2018-05-14 18:42:30] [1980][move1 (2/2)][final] lik=-523.4160 dlik=9.9798e-08 liks=-5.2195e+02 likm=0.0000e+00
## INFO [2018-05-14 18:42:30] done with reptitions 2/2
## INFO [2018-05-14 18:42:30] drawing 0.100000 from the stayers
## INFO [2018-05-14 18:42:56] [1999][stayers] lik=1.5242e+03 inc=8.4762e-09 max-pchg=1.1677e-05 mean-pchg=1.5569e-06
##   cor_kl cov_kl var_k var_l    rsq
## 1 0.2416  0.178 0.229 0.593 0.6711</code></pre>
</div>
<div id="plotting-the-results" class="section level1">
<h1 class="hasAnchor">
<a href="#plotting-the-results" class="anchor"></a>Plotting the results</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/m2.mixt.wplot.html">m2.mixt.wplot</a></span>(res<span class="op">$</span>model<span class="op">$</span>A1)</code></pre></div>
<p><img src="example_mixt_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/m2.mixt.wplot.html">m2.mixt.wplot</a></span>(model<span class="op">$</span>A1)</code></pre></div>
<p><img src="example_mixt_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/m2.mixt.pplot.html">m2.mixt.pplot</a></span>(res<span class="op">$</span>model<span class="op">$</span>pk0[<span class="dv">1</span>,,])</code></pre></div>
<p><img src="example_mixt_files/figure-html/unnamed-chunk-5-3.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/m2.mixt.pplot.html">m2.mixt.pplot</a></span>(model<span class="op">$</span>pk0[<span class="dv">1</span>,,])</code></pre></div>
<p><img src="example_mixt_files/figure-html/unnamed-chunk-5-4.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#simulating-a-data-set">Simulating a data set</a></li>
      <li><a href="#clustering-firms">Clustering firms</a></li>
      <li><a href="#estimating-the-model">Estimating the model</a></li>
      <li><a href="#plotting-the-results">Plotting the results</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Stephane Bonhomme, Thibaut Lamadon, Elena Manresa.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
